<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Internet Archive Book Search & Read</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin-right: 5px;
    }
    .book {
      display: flex;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
      padding: 15px;
      border: 2px solid #4caf50;
      border-radius: 10px;
      background-color: #f9fff9;
    }
    .cover {
      width: 100px;
      height: 150px;
      object-fit: cover;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .details {
      flex-grow: 1;
    }
    .actions button {
      margin-top: 10px;
      margin-right: 10px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>üìö Internet Archive Book Search & Read</h2>
<input type="text" id="searchInput" placeholder="Enter book title or author" />
<button onclick="searchBooks()">Search</button>

<div id="results"></div>

<script>
  async function checkPdfExists(url) {
    try {
      const response = await fetch(url, { method: 'HEAD' });
      return response.ok;
    } catch {
      return false;
    }
  }

  async function searchBooks() {
    const query = document.getElementById('searchInput').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = '';

    if (!query) {
      alert('Please enter a search term.');
      return;
    }

    resultsDiv.innerHTML = 'üîç Searching...';

    // Internet Archive Advanced Search API URL (texts only)
    const url = `https://archive.org/advancedsearch.php?q=(${encodeURIComponent(query)}) AND mediatype:texts&fl[]=identifier,title,creator,year&sort[]=downloads desc&output=json&rows=20`;

    try {
      const response = await fetch(url);
      const data = await response.json();

      if (!data.response.docs || data.response.docs.length === 0) {
        resultsDiv.innerHTML = '‚ùå No books found.';
        return;
      }

      resultsDiv.innerHTML = '';

      for (const book of data.response.docs) {
        const div = document.createElement('div');
        div.className = 'book';

        const title = book.title || 'Unknown Title';
        const author = book.creator || 'Unknown Author';
        const year = book.year || 'N/A';
        const identifier = book.identifier;

        const coverUrl = `https://archive.org/services/img/${identifier}`;
        const embedUrl = `https://archive.org/stream/${identifier}`; // Using /stream/ to open readable view
        const pdfUrl = `https://archive.org/download/${identifier}/${identifier}.pdf`;

        // Check if PDF exists (HEAD request)
        const downloadAvailable = await checkPdfExists(pdfUrl);

        div.innerHTML = `
          <img src="${coverUrl}" alt="Cover" class="cover" onerror="this.onerror=null;this.src='https://via.placeholder.com/100x150?text=No+Cover';" />
          <div class="details">
            <strong>üìñ Title:</strong> ${title}<br />
            <strong>‚úçÔ∏è Author:</strong> ${author}<br />
            <strong>üìÖ Published:</strong> ${year}<br />
            <div class="actions">
              <button onclick="openReadPage('${embedUrl}')">üìñ Read</button>
              ${
                downloadAvailable
                  ? `<button onclick="downloadPdf('${pdfUrl}', '${sanitizeFilename(title)}')">‚¨áÔ∏è Download PDF</button>`
                  : `<button disabled style="opacity:0.6;cursor:not-allowed;">‚¨áÔ∏è Download Unavailable</button>`
              }
            </div>
          </div>
        `;

        resultsDiv.appendChild(div);
      }
    } catch (error) {
      console.error(error);
      resultsDiv.innerHTML = '‚ö†Ô∏è Error fetching data.';
    }
  }

  function openReadPage(url) {
    // Opens preview in a new fullscreen tab/window
    window.open(url, '_blank', 'fullscreen=yes');
  }

  function sanitizeFilename(name) {
    return name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
  }

  function downloadPdf(url, filename) {
    const link = document.createElement('a');
    link.href = url;
    link.download = `${filename}.pdf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
</script>

</body>
</html>
